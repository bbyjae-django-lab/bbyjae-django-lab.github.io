<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<title>JUMBL</title>
<style>
  :root{
    --bg:#f7f7f9; --fg:#1f2328; --muted:#6a6f76;
    --tile:#ffffff; --tile-empty:#e9ebef;
    /* Light: balanced + soft 3-stop gradient */
    --grad1:#FFB36C; --grad2:#FF8FC6; --grad3:#FFA6E6;
    --stop1:0%; --stop2:45%; --stop3:100%;
    --danger:#ff5c7a;
    --shadow:0 6px 20px rgba(0,0,0,.08);
    --radius:16px;
    --sheet:#ffffff;
  }
  .dark{
    --bg:#0f1115; --fg:#e6e7eb; --muted:#9aa1aa;
    --tile:#171a20; --tile-empty:#1f2430;
    /* Dark: periwinkle→aqua→mint, balanced */
    --grad1:#9AA9FF; --grad2:#71D3CF; --grad3:#46E39C;
    --stop1:0%; --stop2:45%; --stop3:100%;
    --danger:#ff6b88;
    --shadow:0 8px 24px rgba(0,0,0,.35);
    --sheet:#12161e;
  }

  /* Global + iOS compatibility */
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html{ height:100%; width:100%; -webkit-text-size-adjust:100%; overflow-x:hidden; }
  body{
    margin:0; min-height:100%; width:100%; max-width:100%; overflow-x:hidden;
    font-family: system-ui, -apple-system, "SF Pro Text", Segoe UI, Roboto, Arial, sans-serif;
    background:var(--bg); color:var(--fg);
  }

  .app{
    width: min(var(--vw, 100vw), 600px);
    margin: 0 auto;
    min-height:100%;
    padding:
      calc(env(safe-area-inset-top,0px) + 16px)
      12px
      calc(env(safe-area-inset-bottom,0px) + 18px);
    display:grid;
    grid-template-rows:auto auto auto auto auto auto 1fr; /* no stretching under timer */
    gap:12px;
  }
  @supports (min-height: 100dvh){ .app{ min-height:100dvh; } }

  /* Reusable gradient helpers */
  .grad-bg{
    background:linear-gradient(90deg,var(--grad1) var(--stop1),var(--grad2) var(--stop2),var(--grad3) var(--stop3));
  }
  .grad-text{
    background:linear-gradient(90deg,var(--grad1) var(--stop1),var(--grad2) var(--stop2),var(--grad3) var(--stop3));
    -webkit-background-clip:text; background-clip:text;
    -webkit-text-fill-color:transparent; color:transparent;
  }

  /* Header */
  header{
    display:grid; grid-template-columns: 1fr auto 1fr;
    align-items:center; gap:8px; padding-block:4px;
  }
  .title{
    grid-column:2; text-align:center;
    font-weight:900; letter-spacing:1.4px;
    font-size:clamp(44px, 12vw, 64px);
    line-height:1.05;
    margin-top:10px; margin-bottom:16px;
  }
  .title.grad-text{-webkit-text-fill-color:transparent;}

  .theme-toggle{
    justify-self:end; border:none; padding:8px; border-radius:999px;
    box-shadow:var(--shadow); touch-action: manipulation;
  }
  .theme-toggle svg{ width:28px; height:28px; display:block; color:#fff; }
  .theme-toggle.grad-bg{ }

  /* Lives: rounded boxes */
  .lives{ display:flex; justify-content:center; gap:8px; }
  .life{ width:16px; height:16px; border-radius:10px; background:var(--tile-empty); box-shadow:var(--shadow); }
  .life.on.grad-bg{ }

  /* Level (numerals) */
  .levelbar{ display:flex; align-items:center; justify-content:flex-start; font-size:14px; color:var(--muted); padding:0 2px; }

  /* Countdown — tight, no extra space */
  .countdown{ background:var(--tile); border-radius:var(--radius); box-shadow:var(--shadow); padding:8px 10px; }
  .cd-bar{ position:relative; height:16px; border-radius:12px; overflow:hidden; background:var(--tile-empty); }
  .cd-fill{ position:absolute; inset:0 auto 0 0; width:0%; transition: width 100ms linear; will-change: width; filter:saturate(.9) brightness(1.02); }
  .cd-fill.grad-bg{ }

  /* Tiles (answer row) */
  .answer-row{ display:grid; grid-template-columns:repeat(5,1fr); gap:8px; margin-top:6px; }
  .tile{
    aspect-ratio:1/1; display:grid; place-items:center;
    border-radius:14px; color:var(--fg);
    font-size:clamp(24px,8vw,32px); font-weight:900; letter-spacing:1px;
    box-shadow:var(--shadow);
    transition: transform .2s ease, opacity .2s ease;
    user-select:none; -webkit-user-select:none;
    opacity:.65; /* empty look */
  }
  .tile.filled{ opacity:1; }
  .tile.correct{ animation: correctGrow 240ms ease; }
  .answer-row.shake{ animation: shake 260ms ease; }

  /* Bank */
  .bank{ display:grid; grid-template-columns:repeat(5,1fr); gap:10px; margin-top:2px; }
  .bank button{
    aspect-ratio:1/1; border:none; border-radius:14px; background:var(--tile);
    box-shadow:var(--shadow); touch-action: manipulation; user-select:none; -webkit-user-select:none; -webkit-touch-callout:none;
    display:flex; align-items:center; justify-content:center;
  }
  .bank button:disabled{ opacity:.35; } /* equal sizes */
  .bank .letter{ font-size:clamp(20px,7vw,28px); font-weight:900; letter-spacing:1px; }

  .controls{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:2px; }
  .controls button{
    border:none; border-radius:14px; background:var(--tile); color:var(--fg);
    box-shadow:var(--shadow); min-height:64px; touch-action: manipulation; user-select:none; -webkit-user-select:none; -webkit-touch-callout:none;
    display:flex; align-items:center; justify-content:center; padding:0;
  }
  .btn-symbol{ line-height:1; display:block; font-weight:900; font-size:clamp(28px,9vw,36px); }

  /* Spacer pushes leftover space below buttons (not under timer) */
  .spacer{ min-height:1px; }

  /* Modals */
  .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:24px; z-index:1000; }
  .modal.show{ display:flex; }
  .overlay{ position:absolute; inset:0; background:rgba(0,0,0,.35); backdrop-filter: blur(2px); }
  .sheet{
    position:relative; width:100%; max-width:480px;
    max-height: calc(100% - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 32px);
    background:var(--sheet); color:var(--fg);
    border-radius:24px; padding:22px 18px 16px; box-shadow:var(--shadow);
    display:grid; grid-template-rows:auto 1fr auto; gap:12px; text-align:center;
  }
  .sheet h2{ margin:0; font-size:22px; }
  .gbtn{
    border:none; border-radius:14px; color:white; padding:14px; font-weight:800;
    box-shadow:var(--shadow); filter:saturate(.9) brightness(1.02);
  }

  .hidden{ display:none !important; }

  /* Animations */
  @keyframes correctGrow{ 0%{transform:scale(1);opacity:1;}60%{transform:scale(1.2);opacity:.9;}100%{transform:scale(1);opacity:1;} }
  @keyframes shake{ 0%{transform:translateX(0);}20%{transform:translateX(-8px);}40%{transform:translateX(8px);}60%{transform:translateX(-6px);}80%{transform:translateX(6px);}100%{transform:translateX(0);} }

  button{ min-height:44px; }
</style>
</head>
<body>
  <div id="root" class="app">
    <header>
      <div></div>
      <div class="title grad-text">JUMBL</div>
      <button id="themeBtn" class="theme-toggle grad-bg" aria-label="Toggle theme">
        <svg id="themeIcon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"></svg>
      </button>
    </header>

    <div class="lives" id="livesRow" aria-label="Lives"></div>
    <div class="levelbar"><div class="level" id="levelLabel">lvl 1</div></div>

    <div class="countdown" aria-live="polite">
      <div class="cd-bar"><div id="cdFill" class="cd-fill grad-bg"></div></div>
    </div>

    <div class="answer-row" id="answerRow" aria-label="Your guess"></div>
    <div class="bank" id="bankRow" aria-label="Letter bank"></div>

    <div class="controls">
      <button id="shuffleBtn" aria-label="Shuffle letters"><span class="btn-symbol grad-text">⇄</span></button>
      <button id="backBtn" aria-label="Backspace"><span class="btn-symbol grad-text">⌫</span></button>
    </div>

    <div class="spacer"></div>
  </div>

  <!-- Intro Modal -->
  <div id="introModal" class="modal">
    <div class="overlay"></div>
    <div class="sheet">
      <h2 class="grad-text">How to play</h2>
      <div class="content">
        Make any valid 5-letter word from the shuffled letters.<br/>
        A correct word advances the level and resets the timer.<br/><br/>
        <strong>30s per word • 3 lives</strong>
      </div>
      <div class="actions"><button id="playBtn" class="gbtn grad-bg">Play</button></div>
    </div>
  </div>

  <!-- Game Over Modal -->
  <div id="gameOverModal" class="modal">
    <div class="overlay"></div>
    <div class="sheet">
      <h2 class="grad-text">Game Over</h2>
      <div class="content"><p id="summaryText"></p></div>
      <div class="actions"><button id="againBtn" class="gbtn grad-bg">try again ➜</button></div>
    </div>
  </div>

  <!-- Loading / Retry Modal -->
  <div id="fetchModal" class="modal show">
    <div class="overlay"></div>
    <div class="sheet">
      <h2 class="grad-text">Loading word lists…</h2>
      <div class="content" id="fetchStatus">Fetching <code>answers.txt</code> and <code>guesses.txt</code></div>
      <div class="actions"><button id="retryBtn" class="gbtn grad-bg">Retry</button></div>
    </div>
  </div>

<script>
(()=> {
  // ===== Config =====
  const COUNTDOWN_SECONDS = 30;
  const STARTING_LIVES   = 3;

  // ===== State =====
  let ACCEPTED_SET = new Set();
  let ANSWER_POOL  = [];
  let ANSWER_SET   = new Set();
  let bank = [];                    // [{ch, used}]
  let current = [];                 // [{ch, bankIndex}]
  let lives = STARTING_LIVES;
  let level = 1;
  let wordDeadlineAt = 0;
  let wordTimerInterval = null;
  let isAnimating = false;

  // ===== Elements =====
  const livesRow   = document.getElementById('livesRow');
  const levelLabel = document.getElementById('levelLabel');
  const cdFill     = document.getElementById('cdFill');
  const answerRow  = document.getElementById('answerRow');
  const bankRow    = document.getElementById('bankRow');
  const shuffleBtn = document.getElementById('shuffleBtn');
  const backBtn    = document.getElementById('backBtn');

  const introModal   = document.getElementById('introModal');
  const playBtn      = document.getElementById('playBtn');
  const gameOverModal= document.getElementById('gameOverModal');
  const againBtn     = document.getElementById('againBtn');

  const fetchModal   = document.getElementById('fetchModal');
  const fetchStatus  = document.getElementById('fetchStatus');
  const retryBtn     = document.getElementById('retryBtn');
  const themeBtn     = document.getElementById('themeBtn');
  const themeIcon    = document.getElementById('themeIcon');

  // ===== Utilities =====
  const sleep = ms => new Promise(r=>setTimeout(r,ms));
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const randInt = n => Math.floor(Math.random()*n);
  function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=randInt(i+1); [a[i],a[j]]=[a[j],a[i]]; } }

  // Visual viewport width lock (fixes iOS zoom mismatch)
  function setVwVar(){
    const vv = window.visualViewport;
    const vw = vv ? vv.width : Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
    document.documentElement.style.setProperty('--vw', vw + 'px');
  }
  setVwVar();
  if (window.visualViewport){
    visualViewport.addEventListener('resize', setVwVar);
    visualViewport.addEventListener('scroll', setVwVar);
  }
  window.addEventListener('orientationchange', setVwVar);
  window.addEventListener('resize', setVwVar);
  window.addEventListener('pageshow', setVwVar);

  // Icons: crisp sun (perfect circle of dots) / crescent moon
  function setSun(){
    themeIcon.innerHTML = `
      <circle cx="12" cy="12" r="4"/>
      <circle cx="12" cy="4" r="1.1"/>
      <circle cx="17.657" cy="6.343" r="1.1"/>
      <circle cx="20" cy="12" r="1.1"/>
      <circle cx="17.657" cy="17.657" r="1.1"/>
      <circle cx="12" cy="20" r="1.1"/>
      <circle cx="6.343" cy="17.657" r="1.1"/>
      <circle cx="4" cy="12" r="1.1"/>
      <circle cx="6.343" cy="6.343" r="1.1"/>
    `;
  }
  function setMoon(){ themeIcon.innerHTML = '<path d="M20.354 14.354a8.25 8.25 0 1 1-10.708-10.71 7 7 0 1 0 10.708 10.71Z"/>'; }
  function setTheme(t){
    const r=document.documentElement;
    if(t==='dark'){ r.classList.add('dark'); setMoon(); }
    else { r.classList.remove('dark'); setSun(); }
    sessionStorage.setItem('jumbl-theme',t);
  }
  function toggleTheme(){ setTheme(document.documentElement.classList.contains('dark')?'light':'dark'); }

  // ===== Data I/O =====
  async function loadWordLists(){
    fetchModal.classList.add('show'); fetchStatus.textContent='Fetching lists…'; retryBtn.disabled=true;
    try{
      const [ansRes, guessRes] = await Promise.all([
        fetch('answers.txt',{cache:'no-store'}),
        fetch('guesses.txt',{cache:'no-store'})
      ]);
      if(!ansRes.ok) throw new Error(`answers.txt HTTP ${ansRes.status}`);
      if(!guessRes.ok) throw new Error(`guesses.txt HTTP ${guessRes.status}`);

      const [ansText, guessText] = await Promise.all([ansRes.text(), guessRes.text()]);
      const toWords = t => t.split(/\r?\n/).map(s=>s.trim().toUpperCase()).filter(w=>/^[A-Z]{5}$/.test(w));

      ANSWER_POOL = toWords(ansText);
      ANSWER_SET  = new Set(ANSWER_POOL);
      ACCEPTED_SET= new Set(toWords(guessText));

      if(!ANSWER_POOL.length) throw new Error('answers.txt is empty');
      if(!ACCEPTED_SET.size)  throw new Error('guesses.txt is empty');

      fetchStatus.textContent = `Loaded ${ANSWER_POOL.length} answers, ${ACCEPTED_SET.size} guesses.`;
      await sleep(200);
      fetchModal.classList.remove('show');
      introModal.classList.add('show');
    }catch(err){
      fetchStatus.textContent = `Failed: ${err.message}. Ensure both files are beside index.html.`;
      retryBtn.disabled=false;
    }
  }

  // ===== Game loop =====
  function resetState(){ lives=STARTING_LIVES; level=1; current=[]; bank=[]; }
  function startGame(){ resetState(); introModal.classList.remove('show'); gameOverModal.classList.remove('show'); nextWord(false); renderUI(); }

  function pickBankFromAnswers(){
    const word = ANSWER_POOL[randInt(ANSWER_POOL.length)];
    const letters = word.split(''); shuffleArray(letters);
    bank = letters.map(ch=>({ch,used:false}));
  }

  function nextWord(incrementLevel){
    stopWordTimer();
    if(incrementLevel) level++;
    current=[]; pickBankFromAnswers(); startWordTimer(); renderUI();
  }

  function startWordTimer(){ wordDeadlineAt=performance.now()+COUNTDOWN_SECONDS*1000; tickWordTimer(); wordTimerInterval=setInterval(tickWordTimer,100); }
  function stopWordTimer(){ if(wordTimerInterval) clearInterval(wordTimerInterval); wordTimerInterval=null; }
  function tickWordTimer(){
    const now=performance.now(), total=COUNTDOWN_SECONDS*1000, remain=clamp(wordDeadlineAt-now,0,total);
    cdFill.style.width = `${(remain/total)*100}%`;
    if(remain<=0) onWordTimeout();
  }

  function onWordTimeout(){
    stopWordTimer();
    lives = Math.max(0, lives-1);
    if(lives===0){ gameOver(); return; }
    current=[]; pickBankFromAnswers(); startWordTimer(); renderUI();
  }
  function gameOver(){
    stopWordTimer();
    const levelsCompleted=Math.max(0,level-1);
    document.getElementById('summaryText').textContent=`You reached level ${levelsCompleted}.`;
    gameOverModal.classList.add('show');
  }

  // ===== Input =====
  function handleLetterTap(letter, bankIndex){
    if(isAnimating) return;
    if(bank[bankIndex]?.used) return;
    if(current.length>=5) return;
    bank[bankIndex].used=true;
    current.push({ch:letter,bankIndex});
    renderUI(); autoSubmitIfFull();
  }
  function handleBackspace(){
    if(isAnimating||!current.length) return;
    const last=current.pop(); if(last&&bank[last.bankIndex]) bank[last.bankIndex].used=false;
    renderUI();
  }
  function shuffleBank(){
    const unused=[],pos=[];
    bank.forEach((b,i)=>{ if(!b.used){ unused.push(b.ch); pos.push(i);} });
    shuffleArray(unused); pos.forEach((p,i)=> bank[p].ch=unused[i]);
    renderUI();
  }
  function autoSubmitIfFull(){ if(current.length===5){ submitGuess(current.map(x=>x.ch).join('')); } }

  async function submitGuess(word){
    if(isAnimating) return;
    const upper = word.toUpperCase();
    const isValid = ACCEPTED_SET.has(upper) || ANSWER_SET.has(upper);
    if(isValid){
      isAnimating=true;
      document.querySelectorAll('.tile').forEach(t=>t.classList.add('correct'));
      await sleep(200); isAnimating=false;
      nextWord(true); renderUI();
    }else{
      isAnimating=true;
      answerRow.classList.add('shake'); await sleep(240); answerRow.classList.remove('shake');
      while(current.length){ const x=current.pop(); if(bank[x.bankIndex]) bank[x.bankIndex].used=false; }
      isAnimating=false; renderUI();
    }
  }

  // ===== Render =====
  function renderUI(){
    // Lives
    livesRow.innerHTML='';
    for(let i=0;i<STARTING_LIVES;i++){
      const d=document.createElement('div'); d.className='life'+(i<lives?' on grad-bg':''); livesRow.appendChild(d);
    }
    // Numeral level
    levelLabel.textContent='lvl '+Math.max(1,level);

    // Answer row (gradient background tiles, bold letters)
    answerRow.innerHTML='';
    for(let i=0;i<5;i++){
      const t=document.createElement('div');
      t.className='tile grad-bg'+(current[i]?' filled':'');
      t.textContent=current[i]?.ch??''; // solid text for readability
      answerRow.appendChild(t);
    }

    // Bank (gradient text letters)
    bankRow.innerHTML='';
    bank.forEach((b,idx)=>{
      const btn=document.createElement('button');
      btn.type='button'; btn.disabled=b.used;
      btn.dataset.index = String(idx);
      btn.setAttribute('aria-label',`Use letter ${b.ch}`);
      const span=document.createElement('span');
      span.className='letter grad-text';
      span.textContent=b.ch;
      btn.appendChild(span);
      bankRow.appendChild(btn);
    });
  }

  // ===== Wiring (fast pointer events) =====
  document.getElementById('bankRow').addEventListener('pointerdown', (e)=>{
    const btn = e.target.closest('button');
    if(!btn || btn.disabled) return;
    const idx = Number(btn.dataset.index);
    if(Number.isInteger(idx)) handleLetterTap(bank[idx].ch, idx);
  }, {passive:true});

  shuffleBtn.addEventListener('pointerdown', (e)=>{ e.preventDefault(); shuffleBank(); }, {passive:false});
  backBtn.addEventListener('pointerdown', (e)=>{ e.preventDefault(); handleBackspace(); }, {passive:false});
  playBtn.addEventListener('pointerdown', (e)=>{ e.preventDefault(); startGame(); }, {passive:false});
  againBtn.addEventListener('pointerdown', (e)=>{ e.preventDefault(); gameOverModal.classList.remove('show'); startGame(); }, {passive:false});
  retryBtn.addEventListener('pointerdown', (e)=>{ e.preventDefault(); loadWordLists(); }, {passive:false});
  themeBtn.addEventListener('pointerdown', (e)=>{ e.preventDefault(); toggleTheme(); }, {passive:false});

  // Theme boot
  setTheme(sessionStorage.getItem('jumbl-theme')
    || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light'));

  // Boot
  loadWordLists();
})();
</script>
</body>
</html>
