<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<title>JUMBL</title>
<style>
  :root{
    --bg:#f7f7f9; --fg:#1f2328; --muted:#6a6f76;
    --tile:#ffffff; --tile-empty:#e9ebef;
    --accent:#6b8afd; --ok:#35c47c; /* gradient */
    --accent-weak:#c9d4ff;
    --danger:#ff5c7a;
    --shadow:0 6px 20px rgba(0,0,0,.08);
    --radius:16px;
    --sheet:#ffffff;
  }
  .dark{
    --bg:#0f1115; --fg:#e6e7eb; --muted:#9aa1aa;
    --tile:#171a20; --tile-empty:#1f2430;
    --accent:#8aa4ff; --ok:#3ed695;
    --accent-weak:#2b3760;
    --danger:#ff6b88;
    --shadow:0 8px 24px rgba(0,0,0,.35);
    --sheet:#12161e;
  }

  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html{ height:100%; -webkit-text-size-adjust:100%; }
  body{
    margin:0; min-height:100%;
    font-family: system-ui, -apple-system, "SF Pro Text", Segoe UI, Roboto, Arial, sans-serif;
    background:var(--bg); color:var(--fg);
  }

  .app{
    min-height:100%;
    padding:
      calc(env(safe-area-inset-top,0px) + 12px)
      12px
      calc(env(safe-area-inset-bottom,0px) + 18px);
    display:grid;
    grid-template-rows:auto auto auto 1fr auto auto;
    gap:10px;
    max-width:600px; margin:0 auto;
  }

  /* Transparent header (no bar) */
  header{
    display:grid; grid-template-columns: 1fr auto 1fr;
    align-items:center; gap:8px;
  }
  .title{
    grid-column:2; text-align:center;
    font-weight:900; letter-spacing:1px;
    font-size:clamp(22px,5.2vw,28px);
  }
  .theme-toggle{
    justify-self:end; border:none; background:transparent;
    padding:6px; border-radius:999px;
  }
  .theme-toggle svg{
    width:28px; height:28px; display:block;
    filter: drop-shadow(0 2px 6px rgba(0,0,0,.12));
  }
  .dark .theme-toggle svg{ color:#e6e7eb; }
  :not(.dark) .theme-toggle svg{ color:#1f2328; }

  /* Lives: rounded squares */
  .lives{ display:flex; justify-content:center; gap:8px; }
  .life{
    width:12px; height:12px; border-radius:6px;
    background:var(--accent-weak);
  }
  .life.on{ background:var(--accent); }

  /* Level label (left only) */
  .levelbar{
    display:flex; align-items:center; justify-content:flex-start;
    font-size:14px; color:var(--muted); padding:0 2px;
  }

  /* Countdown: big bar, number inside (left) */
  .countdown{
    background:var(--tile); border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:10px 12px 12px;
  }
  .cd-bar{
    position:relative; height:16px; border-radius:12px; overflow:hidden;
    background:var(--tile-empty);
  }
  .cd-fill{
    position:absolute; inset:0 auto 0 0; width:0%;
    background:linear-gradient(90deg, var(--accent), var(--ok));
    transition: width 100ms linear;
  }
  .cd-text{
    position:absolute; left:10px; top:50%; transform:translateY(-50%);
    font-variant-numeric: tabular-nums;
    font-size:13px; color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.35);
    pointer-events:none;
  }

  .answer-row{
    display:grid; grid-template-columns:repeat(5,1fr);
    gap:8px; margin-top:8px; /* closer to bar */
  }
  .tile{
    aspect-ratio:1/1; display:grid; place-items:center;
    border-radius:14px; background:var(--tile-empty);
    color:var(--fg); font-size:clamp(22px,7vw,30px);
    font-weight:800; letter-spacing:1px; box-shadow:var(--shadow);
    transition: background .2s ease, transform .2s ease, opacity .2s ease;
  }
  .tile.filled{ background:var(--tile); }
  .tile.correct{ animation: correctGrow 240ms ease; }
  .answer-row.shake{ animation: shake 260ms ease; }

  .bank{
    display:grid; grid-template-columns:repeat(5,1fr);
    gap:10px; margin-top:6px;
  }
  .bank button{
    aspect-ratio:1/1; border:none; border-radius:14px;
    background:var(--tile); color:var(--fg);
    font-size:clamp(20px,7vw,28px); font-weight:900; letter-spacing:1px;
    box-shadow:var(--shadow);
  }
  .bank button:disabled{ opacity:.35; transform:scale(.97); }

  .controls{
    display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:2px;
  }
  .controls button{
    border:none; border-radius:14px; background:var(--tile); color:var(--fg);
    font-size:clamp(16px,4.5vw,18px); font-weight:800; box-shadow:var(--shadow);
    padding:16px; min-height:64px; /* bigger/squarer */
  }

  /* Modals */
  .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:24px; z-index:1000; }
  .modal.show{ display:flex; }
  .overlay{ position:absolute; inset:0; background:rgba(0,0,0,.35); backdrop-filter: blur(2px); }
  .sheet{
    position:relative; width:100%; max-width:480px;
    max-height: calc(100% - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 32px);
    background:var(--sheet); color:var(--fg);
    border-radius:24px; padding:22px 18px 16px; box-shadow:var(--shadow);
    display:grid; grid-template-rows:auto 1fr auto; gap:12px; text-align:center;
  }
  .sheet h2{ margin:0; font-size:22px; }
  .sheet .content{ overflow:auto; -webkit-overflow-scrolling:touch; font-size:15px; color:var(--muted); line-height:1.5; }
  .sheet .actions{ display:grid; gap:8px; }
  .gbtn{
    border:none; border-radius:14px; color:white; padding:14px; font-weight:800;
    background:linear-gradient(90deg, var(--accent), var(--ok));
  }

  .hidden{ display:none !important; }

  /* Animations */
  @keyframes correctGrow{ 0%{transform:scale(1);opacity:1;}60%{transform:scale(1.2);opacity:.9;}100%{transform:scale(1);opacity:1;} }
  @keyframes shake{ 0%{transform:translateX(0);}20%{transform:translateX(-8px);}40%{transform:translateX(8px);}60%{transform:translateX(-6px);}80%{transform:translateX(6px);}100%{transform:translateX(0);} }

  button{ min-height:44px; }
</style>
</head>
<body>
  <div id="root" class="app">
    <header>
      <div></div>
      <div class="title">JUMBL</div>
      <button id="themeBtn" class="theme-toggle" aria-label="Toggle theme">
        <svg id="themeIcon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"></svg>
      </button>
    </header>

    <div class="lives" id="livesRow" aria-label="Lives"></div>

    <div class="levelbar"><div class="level" id="levelLabel">lvl one</div></div>

    <div class="countdown" aria-live="polite">
      <div class="cd-bar">
        <div id="cdFill" class="cd-fill"></div>
        <div id="cdText" class="cd-text">30.0s</div>
      </div>
    </div>

    <div class="answer-row" id="answerRow" aria-label="Your guess"></div>

    <div class="bank" id="bankRow" aria-label="Letter bank"></div>

    <div class="controls">
      <button id="shuffleBtn" aria-label="Shuffle letters">shuffle</button>
      <button id="backBtn" aria-label="Backspace">⌫</button>
    </div>
  </div>

  <!-- Intro Modal -->
  <div id="introModal" class="modal">
    <div class="overlay"></div>
    <div class="sheet">
      <h2>How to play</h2>
      <div class="content">
        Make any valid 5-letter word from the shuffled letters.<br/>
        A correct word advances the level and resets the timer.<br/><br/>
        <strong>30s per word • 3 lives</strong>
      </div>
      <div class="actions"><button id="playBtn" class="gbtn">Play</button></div>
    </div>
  </div>

  <!-- Game Over Modal -->
  <div id="gameOverModal" class="modal">
    <div class="overlay"></div>
    <div class="sheet">
      <h2>Game Over</h2>
      <div class="content"><p id="summaryText"></p></div>
      <div class="actions"><button id="againBtn" class="gbtn">try again ➜</button></div>
    </div>
  </div>

  <!-- Loading / Retry Modal -->
  <div id="fetchModal" class="modal show">
    <div class="overlay"></div>
    <div class="sheet">
      <h2>Loading word lists…</h2>
      <div class="content" id="fetchStatus">Fetching <code>answers.txt</code> and <code>guesses.txt</code></div>
      <div class="actions"><button id="retryBtn" class="gbtn">Retry</button></div>
    </div>
  </div>

<script>
(()=> {
  // ===== Config =====
  const COUNTDOWN_SECONDS = 30;     // per-word timer
  const STARTING_LIVES   = 3;

  // ===== State =====
  let ACCEPTED_SET = new Set();     // guesses.txt
  let ANSWER_POOL  = [];            // answers.txt (array)
  let ANSWER_SET   = new Set();     // answers.txt (set) – used for acceptance union
  let bank = [];                    // [{ch, used}]
  let current = [];                 // [{ch, bankIndex}]
  let lives = STARTING_LIVES;
  let level = 1;
  let wordDeadlineAt = 0;
  let wordTimerInterval = null;
  let isAnimating = false;

  // ===== Elements =====
  const livesRow   = document.getElementById('livesRow');
  const levelLabel = document.getElementById('levelLabel');
  const cdFill     = document.getElementById('cdFill');
  const cdText     = document.getElementById('cdText');
  const answerRow  = document.getElementById('answerRow');
  const bankRow    = document.getElementById('bankRow');
  const shuffleBtn = document.getElementById('shuffleBtn');
  const backBtn    = document.getElementById('backBtn');

  const introModal   = document.getElementById('introModal');
  const playBtn      = document.getElementById('playBtn');
  const gameOverModal= document.getElementById('gameOverModal');
  const againBtn     = document.getElementById('againBtn');

  const fetchModal   = document.getElementById('fetchModal');
  const fetchStatus  = document.getElementById('fetchStatus');
  const retryBtn     = document.getElementById('retryBtn');
  const themeBtn     = document.getElementById('themeBtn');
  const themeIcon    = document.getElementById('themeIcon');

  // ===== Utilities =====
  const sleep = ms => new Promise(r=>setTimeout(r,ms));
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const randInt = n => Math.floor(Math.random()*n);
  function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=randInt(i+1); [a[i],a[j]]=[a[j],a[i]]; } }
  const words1to19=["zero","one","two","three","four","five","six","seven","eight","nine","ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"];
  const tensWords=["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"];
  const numberToWords=n=> n<20?words1to19[n]:n<100?(tensWords[Math.floor(n/10)]+(n%10?`-${words1to19[n%10]}`:"")):String(n);

  function setSun(){ themeIcon.innerHTML='<path d="M12 4.75a.75.75 0 0 1 .75-.75h.5a.75.75 0 0 1 0 1.5h-.5A.75.75 0 0 1 12 4.75Zm6.364 2.386a.75.75 0 0 1 1.06 1.06l-.354.354a.75.75 0 1 1-1.06-1.06l.354-.354ZM18.75 12a.75.75 0 0 1 .75-.75h.5a.75.75 0 0 1 0 1.5h-.5a.75.75 0 0 1-.75-.75ZM6.99 7.49a.75.75 0 0 1-1.06 1.06l-.354-.354a.75.75 0 0 1 1.06-1.06l.354.354ZM12 7.5A4.5 4.5 0 1 1 7.5 12 4.505 4.505 0 0 1 12 7.5Zm0 9.75a.75.75 0 0 1 .75.75v.5a.75.75 0 0 1-1.5 0v-.5a.75.75 0 0 1 .75-.75Zm-6.364-2.386a.75.75 0 1 1-1.06-1.06l.354-.354a.75.75 0 0 1 1.06 1.06l-.354.354ZM4.75 12a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1 0-1.5h.5a.75.75 0 0 1 .75.75Zm12.26 3.45a.75.75 0 0 1 1.06 0l.354.354a.75.75 0 0 1-1.06 1.06l-.354-.354a.75.75 0 0 1 0-1.06Z"/>'; }
  function setMoon(){ themeIcon.innerHTML='<path d="M20.354 14.354a8.25 8.25 0 1 1-10.708-10.71 7 7 0 1 0 10.708 10.71Z"/>'; }
  function setTheme(t){ const r=document.documentElement; if(t==='dark'){ r.classList.add('dark'); setMoon(); } else { r.classList.remove('dark'); setSun(); } sessionStorage.setItem('jumbl-theme',t); }
  function toggleTheme(){ setTheme(document.documentElement.classList.contains('dark')?'light':'dark'); }

  // ===== Data I/O (two files) =====
  async function loadWordLists(){
    fetchModal.classList.add('show'); fetchStatus.textContent='Fetching lists…'; retryBtn.disabled=true;
    try{
      const [ansRes, guessRes] = await Promise.all([
        fetch('answers.txt',{cache:'no-store'}),
        fetch('guesses.txt',{cache:'no-store'})
      ]);
      if(!ansRes.ok) throw new Error(`answers.txt HTTP ${ansRes.status}`);
      if(!guessRes.ok) throw new Error(`guesses.txt HTTP ${guessRes.status}`);

      const [ansText, guessText] = await Promise.all([ansRes.text(), guessRes.text()]);
      const toWords = t => t.split(/\r?\n/).map(s=>s.trim().toUpperCase()).filter(w=>/^[A-Z]{5}$/.test(w));

      ANSWER_POOL = toWords(ansText);
      ANSWER_SET  = new Set(ANSWER_POOL);
      ACCEPTED_SET= new Set(toWords(guessText));

      if(!ANSWER_POOL.length) throw new Error('answers.txt is empty');
      if(!ACCEPTED_SET.size)  throw new Error('guesses.txt is empty');

      fetchStatus.textContent = `Loaded ${ANSWER_POOL.length} answers, ${ACCEPTED_SET.size} guesses.`;
      await sleep(300);
      fetchModal.classList.remove('show');
      introModal.classList.add('show');
    }catch(err){
      fetchStatus.textContent = `Failed: ${err.message}. Ensure both files are beside index.html.`;
      retryBtn.disabled=false;
    }
  }

  // ===== Game loop =====
  function resetState(){ lives=STARTING_LIVES; level=1; current=[]; bank=[]; }
  function startGame(){ resetState(); introModal.classList.remove('show'); gameOverModal.classList.remove('show'); nextWord(false); renderUI(); }

  function pickBankFromAnswers(){
    const word = ANSWER_POOL[randInt(ANSWER_POOL.length)];
    const letters = word.split(''); shuffleArray(letters);
    bank = letters.map(ch=>({ch,used:false}));
  }

  function nextWord(incrementLevel){ stopWordTimer(); if(incrementLevel) level++; current=[]; pickBankFromAnswers(); startWordTimer(); renderUI(); }

  function startWordTimer(){ wordDeadlineAt=performance.now()+COUNTDOWN_SECONDS*1000; tickWordTimer(); wordTimerInterval=setInterval(tickWordTimer,100); }
  function stopWordTimer(){ if(wordTimerInterval) clearInterval(wordTimerInterval); wordTimerInterval=null; }
  function tickWordTimer(){
    const now=performance.now(), total=COUNTDOWN_SECONDS*1000, remain=clamp(wordDeadlineAt-now,0,total);
    cdFill.style.width = `${(remain/total)*100}%`;
    cdText.textContent = (remain/1000).toFixed(1)+'s';
    if(remain<=0) onWordTimeout();
  }

  function onWordTimeout(){ stopWordTimer(); lives=Math.max(0,lives-1); if(lives===0){ gameOver(); return; } current=[]; pickBankFromAnswers(); startWordTimer(); renderUI(); }
  function gameOver(){
    stopWordTimer();
    const levelsCompleted=Math.max(0,level-1);
    document.getElementById('summaryText').textContent=`You reached level ${levelsCompleted}.`;
    gameOverModal.classList.add('show');
  }

  // ===== Input =====
  function handleLetterTap(letter, bankIndex){
    if(isAnimating) return;
    if(bank[bankIndex]?.used) return;
    if(current.length>=5) return;
    bank[bankIndex].used=true;
    current.push({ch:letter,bankIndex});
    renderUI(); autoSubmitIfFull();
  }
  function handleBackspace(){
    if(isAnimating||!current.length) return;
    const last=current.pop(); if(last&&bank[last.bankIndex]) bank[last.bankIndex].used=false;
    renderUI();
  }
  function shuffleBank(){
    const unused=[],pos=[];
    bank.forEach((b,i)=>{ if(!b.used){ unused.push(b.ch); pos.push(i);} });
    shuffleArray(unused); pos.forEach((p,i)=> bank[p].ch=unused[i]);
    renderUI();
  }
  function autoSubmitIfFull(){ if(current.length===5){ submitGuess(current.map(x=>x.ch).join('')); } }

  async function submitGuess(word){
    if(isAnimating) return;
    const upper = word.toUpperCase();

    // Accept if present in guesses.txt OR answers.txt
    const isValid = ACCEPTED_SET.has(upper) || ANSWER_SET.has(upper);

    if(isValid){
      isAnimating=true;
      document.querySelectorAll('.tile').forEach(t=>t.classList.add('correct'));
      await sleep(240); isAnimating=false;
      nextWord(true); renderUI();
    }else{
      isAnimating=true;
      answerRow.classList.add('shake'); await sleep(260); answerRow.classList.remove('shake');
      while(current.length){ const x=current.pop(); if(bank[x.bankIndex]) bank[x.bankIndex].used=false; }
      isAnimating=false; renderUI();
    }
  }

  // ===== Render =====
  function renderUI(){
    // Lives
    livesRow.innerHTML='';
    for(let i=0;i<STARTING_LIVES;i++){
      const d=document.createElement('div'); d.className='life'+(i<lives?' on':''); livesRow.appendChild(d);
    }
    levelLabel.textContent='lvl '+numberToWords(Math.max(1,level));

    // Answer row
    answerRow.innerHTML='';
    for(let i=0;i<5;i++){
      const t=document.createElement('div');
      t.className='tile'+(current[i]?' filled':'');
      t.textContent=current[i]?.ch??''; answerRow.appendChild(t);
    }

    // Bank
    bankRow.innerHTML='';
    bank.forEach((b,idx)=>{
      const btn=document.createElement('button');
      btn.type='button'; btn.textContent=b.ch; btn.disabled=b.used;
      btn.setAttribute('aria-label',`Use letter ${b.ch}`);
      btn.addEventListener('click',()=>handleLetterTap(b.ch, idx));
      bankRow.appendChild(btn);
    });

    shuffleBtn.onclick=shuffleBank;
    backBtn.onclick=handleBackspace;
  }

  // ===== Wiring =====
  playBtn.addEventListener('click', startGame);
  againBtn.addEventListener('click', ()=>{ gameOverModal.classList.remove('show'); startGame(); });
  retryBtn.addEventListener('click', loadWordLists);
  themeBtn.addEventListener('click', toggleTheme);

  // Theme boot (SVG icon swap)
  setTheme(sessionStorage.getItem('jumbl-theme')
    || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light'));

  // Prevent double-tap zoom on iOS
  let lastTouch=0;
  document.addEventListener('touchend',(e)=>{ const now=Date.now(); if(now-lastTouch<=300) e.preventDefault(); lastTouch=now; },{passive:false});

  // Optional keyboard (desktop)
  document.addEventListener('keydown',(e)=>{
    if([introModal, gameOverModal, fetchModal].some(m=>m.classList.contains('show'))) return;
    const k=e.key.toUpperCase();
    if(/^[A-Z]$/.test(k)){
      const idx=bank.findIndex(b=>!b.used && b.ch===k);
      if(idx!==-1) handleLetterTap(k, idx);
    } else if(e.key==='Backspace'){ handleBackspace(); }
    else if(e.key===' '){ e.preventDefault(); shuffleBank(); }
  });

  // Boot
  loadWordLists();
})();
</script>
</body>
</html>
